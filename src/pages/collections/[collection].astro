---
// File: src/pages/collections/[collection].astro
export const prerender = true;

import Layout from "../../layouts/Layout.astro";
import PageHeader from "../../components/ui/PageHeader.astro";
import Card from "../../components/ui/Card.astro";
import CrumbsBar from "../../components/ui/CrumbsBar.astro";

import { getCollections } from "../../lib/collections";

/* ---------------- helpers ---------------- */
const s = (v: any) => String(v ?? "").trim();
const slugify = (v: any) =>
  String(v ?? "")
    .trim()
    .toLowerCase()
    .replace(/&/g, "and")
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/^-+|-+$/g, "");

/** Normalize flags from Sheets: commas / semicolons / pipes -> snake_case keys */
function parseFlags(raw: any): string[] {
  const v = s(raw);
  if (!v) return [];
  return v
    .split(/[;,|]/g)
    .map((p) =>
      p
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "_")
        .replace(/-+/g, "_")
        .replace(/[^a-z0-9_]/g, "")
    )
    .filter(Boolean);
}

/** Accept multiple workflow statuses while you build */
function statusOk(r: any): boolean {
  const st = slugify(r?.status ?? r?.Status ?? r?.published ?? r?.Published);
  return st === "published" || st === "done";
}

function getFlagsRaw(r: any): any {
  return (
    r?.lifestyle_flags ??
    r?.lifestyle_flags_clean ??
    r?.lifestyleFlags ??
    r?.LifestyleFlags ??
    r?.lifestyle ??
    r?.Lifestyle ??
    ""
  );
}

async function getJson(u: string) {
  const res = await fetch(u, { headers: { accept: "application/json,text/plain,*/*" } });
  if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
  return await res.json();
}

function toArray(raw: any) {
  if (Array.isArray(raw)) return raw;
  if (Array.isArray(raw?.data)) return raw.data;
  if (Array.isArray(raw?.rows)) return raw.rows;
  return [];
}

/* Friendly labels for primary/secondary (keys -> human) */
const FLAG_LABELS: Record<string, string> = {
  ski_towns: "Ski towns",
  family_friendly: "Family-friendly",
  retirement_friendly: "Retirement-friendly",
  coastal_lifestyle: "Coastal lifestyle",
  regional_hubs: "Regional hubs",
  employment_hubs: "Employment hubs",
  remote_work_friendly: "Remote-work friendly",
  rural_acreage_living: "Rural - acreage living",
};

function flagLabel(k: any): string {
  const key = String(k ?? "").trim().toLowerCase();
  return FLAG_LABELS[key] ?? ""; // blank if unknown
}

/* ---------------- collections data ---------------- */
const { collections: COLLECTIONS } = await getCollections();

/* ---------------- static paths ---------------- */
export async function getStaticPaths() {
  const { collections } = await getCollections();
  return Object.keys(collections).map((key) => ({
    params: { collection: key },
  }));
}

/* ---------------- page params ---------------- */
const { collection } = Astro.params as { collection: string };
const key = slugify(collection);
const cfg = (COLLECTIONS as any)[key];
if (!cfg) throw new Error(`[collections] Unknown collection: ${collection}`);

/* includeAny should already be canonical keys like ["ski_towns"] */
const includeAny = (cfg.includeAny ?? [])
  .map((x: any) => String(x).trim().toLowerCase())
  .filter(Boolean);

/* ---------------- crumbs ---------------- */
const crumbs = [
  { label: "Home", href: "/" },
  { label: "Collections", href: "/collections" },
  { label: cfg.title, href: `/collections/${key}` },
];

/* ---------------- pills ---------------- */
const pills = [
  { label: "Overview", href: "#overview" },
  { label: "Cities", href: "#cities" },
];

/* ---------------- load + filter cities ---------------- */
const CITIES_URL = import.meta.env.PUBLIC_CITIES_JSON as string | undefined;

type CityCard = {
  slug: string;
  name: string;
  subtitle: string;
  primaryKey?: string;   // canonical key (e.g. "retirement_friendly")
  secondaryKey?: string; // canonical key
  primary?: string;      // friendly label
  secondary?: string;    // friendly label
  flags: string[];
};

let matches: CityCard[] = [];

if (CITIES_URL) {
  try {
    const raw = await getJson(CITIES_URL);
    const rows = toArray(raw);

    const all: CityCard[] = rows
      .filter((r: any) => statusOk(r))
      .map((r: any) => {
        const flags = parseFlags(getFlagsRaw(r));
        const primaryKey = s(r?.lifestyle_primary).toLowerCase();
        const secondaryKey = s(r?.lifestyle_secondary).toLowerCase();

        return {
          slug: slugify(r?.city_slug),
          name: s(r?.city_name),
          subtitle: s(r?.subtitle),
          primaryKey,
          secondaryKey,
          primary: flagLabel(primaryKey),
          secondary: flagLabel(secondaryKey),
          flags,
        };
      })
      .filter((c: CityCard) => c.slug && c.name);

    // Map collection slug -> canonical key used in lifestyle_primary/secondary
    const COLLECTION_KEY_MAP: Record<string, string> = {
      "ski-towns": "ski_towns",
      "family-friendly": "family_friendly",
      "retirement-friendly": "retirement_friendly",
      "coastal-lifestyle": "coastal_lifestyle",
      "regional-hubs": "regional_hubs",
      "employment-hubs": "employment_hubs",
      "remote-work-friendly": "remote_work_friendly",
      "rural-acreage-living": "rural_acreage_living",
    };

    const targetKey = COLLECTION_KEY_MAP[key];

    if (!targetKey) {
      // Fallback: old tag behavior (still capped)
      matches = all
        .filter((c) => c.flags.some((f) => includeAny.includes(f)))
        .slice(0, 15);
    } else {
      // Curated behavior:
      // - include ONLY primary + secondary matches (no flag-only fill)
      // - primary first, then secondary top-up, max 15 (but never force to 15)
      const prim = all.filter((c) => c.primaryKey === targetKey);
      const sec = all
        .filter((c) => c.primaryKey !== targetKey)
        .filter((c) => c.secondaryKey === targetKey);

      matches = prim.concat(sec).slice(0, 15);
    }
  } catch {
    matches = [];
  }
}
---

<style is:global>
  :target { scroll-margin-top: 140px; }

  .sticky-pills{
    position: sticky;
    top: 0;
    z-index: 40;
    padding-top: 0.75rem;
    padding-bottom: 0.75rem;
    background: rgba(255, 255, 255, 0.92);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: none;
  }

  .city-card{
    position: relative;
    overflow: hidden;
    background: #ffffff !important;
    transition: transform 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
  }
  .city-card:hover{ transform: translateY(-1px); }

  .city-card::before{
    content:"";
    position:absolute;
    left:0; top:0; bottom:0;
    width:0;
    background: #0f172a;
    opacity:0;
    transition: width 180ms ease, opacity 180ms ease;
    pointer-events:none;
    border-top-left-radius:16px;
    border-bottom-left-radius:16px;
  }

  .city-card:hover,
  .city-card:focus-visible{
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    border-color: rgba(148, 163, 184, .45);
  }

  .city-card:hover::before,
  .city-card:focus-visible::before{
    width:6px;
    opacity:.12;
  }

  .city-title{
    transition: color 160ms ease, transform 160ms ease;
  }
  .city-card:hover .city-title,
  .city-card:focus-visible .city-title{
    color: #0f172a;
    transform: translateX(1px);
  }

  .city-arrow{
    transition: transform 160ms ease, color 160ms ease;
  }
  .city-card:hover .city-arrow,
  .city-card:focus-visible .city-arrow{
    transform: translateX(2px);
    color: #0f172a;
  }

  /* chips */
  .chip{
    display:inline-flex;
    align-items:center;
    border-radius:9999px;
    border:1px solid rgba(226,232,240,1);
    padding:0.125rem 0.5rem;
    font-size:11px;
    line-height:1.2;
    white-space:nowrap;
  }
  .chip-primary{
    background:#ffffff;
    color:rgb(51,65,85);
  }
  .chip-secondary{
    background:rgb(248,250,252);
    color:rgb(71,85,105);
  }

  @media (prefers-reduced-motion: reduce) {
    .city-card,
    .city-card::before,
    .city-title,
    .city-arrow{ transition: none !important; }
    .city-card:hover{ transform:none; }
    .city-card:hover .city-title{ transform:none; }
    .city-card:hover .city-arrow{ transform:none; }
  }
</style>

<Layout
  title={`${cfg.title} - BC Real Estate Collections`}
  description={`${cfg.title} collection - browse BC cities filtered by lifestyle tags.`}
>
  <div class="w-full pt-6 pb-10">
    {/* IMPORTANT: some of your CrumbsBar versions expect `items`, some expect `crumbs`.
        If yours expects `items`, change crumbs={crumbs} -> items={crumbs}. */}
    <CrumbsBar
      crumbs={crumbs}
      helpLabel={`Need help choosing a ${cfg.title.toLowerCase()} community?`}
      helpHref="/contact"
    />

    <PageHeader
      title={`${cfg.icon ?? ""} ${cfg.title}`}
      lead={cfg.lead}
    />

    <div class="sticky-pills mb-3 flex flex-wrap gap-2">
      {pills.map((p) => (
        <a
          href={p.href}
          class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-600 transition hover:border-slate-300 hover:text-slate-900"
        >
          <span class="h-1.5 w-1.5 rounded-full bg-slate-900 opacity-40" aria-hidden="true"></span>
          {p.label}
        </a>
      ))}
    </div>

    <div class="space-y-6">
      <div id="overview">
        <Card class="relative bg-slate-50">
          <div class="text-sm font-semibold text-slate-900">Overview</div>
          <p class="mt-2 text-sm text-slate-600">
            This collection is a tag filter. A city appears if it matches any of the tags mapped to {cfg.title}.
          </p>
          <div class="mt-3 text-xs text-slate-600">
            Matching tags - {includeAny.join(", ")}
          </div>
        </Card>
      </div>

      <section id="cities">
        <div class="flex items-end justify-between gap-4">
          <h2 class="text-base font-semibold text-slate-900">Cities</h2>
          <div class="text-xs text-slate-600">
            {matches.length} {matches.length === 1 ? "match" : "matches"}
          </div>
        </div>

        {matches.length ? (
          <div class="mt-4 grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
            {matches.map((c) => (
              <a
                href={`/cities/${c.slug}`}
                class="city-card group block rounded-2xl border border-slate-200 p-5 shadow-sm focus:outline-none"
              >
                <div class="flex items-start justify-between gap-4">
                  <div class="min-w-0">
                    <div class="city-title text-base font-semibold text-slate-900">{c.name}</div>

                    {(c.primary || c.secondary) ? (
                      <div class="mt-2 flex flex-wrap gap-1.5">
                        {c.primary ? <span class="chip chip-primary">{c.primary}</span> : null}
                        {c.secondary ? <span class="chip chip-secondary">{c.secondary}</span> : null}
                      </div>
                    ) : c.subtitle ? (
                      <p class="mt-2 text-sm text-slate-600">{c.subtitle}</p>
                    ) : null}
                  </div>

                  <span class="city-arrow text-xs font-medium text-slate-500">â†’</span>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <div class="mt-4 text-sm text-slate-600">
            No cities matched this collection yet. Add or normalize lifestyle flags for more coverage.
          </div>
        )}
      </section>
    </div>
  </div>
</Layout>
